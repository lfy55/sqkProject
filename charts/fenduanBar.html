<!DOCTYPE html>
<html lang="en">

<head>
  <title>分段渐变柱状图</title>
  <meta charset="UTF-8">
  <style>
    #main {
      position: absolute;
      width: 600px;
      height: 400px;
    }

    .charts {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .chart-content {
      width: 100%;
      height: calc(100% - 60px);
    }

    .text-content {
      display: flex;
      flex-wrap: nowrap;
      height: 60px;
      justify-content: space-between;
      align-items: stretch;
    }

    .text-content .name {
      font-size: 36px;
      flex-grow: 1;
      height: 100%;
    }

    .text-content .num-before {
      font-size: 30px;
      align-self: flex-end;
    }

    .text-content .num {
      /* font-family: 'pixel'; */
      font-size: 52px;
      height: 100%;
      line-height: 60px;
    }
  </style>
</head>

<body>
  <div id="main">
    <fenduanbar :count="count" :titlename="title" :dataconfig="data"></fenduanbar>
  </div>
</body>
<script src="js/lib/vue-2.1.10.js"></script>
<script src="js/lib/jquery.min.js"></script>
<script src="js/lib/mylib.js"></script>
<script src="js/lib/echarts-3.5.1.min.js"></script>
<script>
  Vue.component('fenduanbar', {
    template: `
    <div class="charts">
    <div class="text-content">
      <span class="name">{{titlename}}</span>
      <span class="num-before">总数</span>
      <span class="num">{{count}}</span>
    </div>
    <div ref="chart" class="chart-content"></div>
  </div>
    `,
    props: ['count', 'titlename', 'dataconfig'],
    data: function () {
      return {
        yAxisData: [],
        seriesData: [],
        chart: undefined
      }
    },
    mounted() {
      let myChart = echarts.init(this.$refs.chart)
      let _this = this

      this.upData()

      myChart.setOption({
        title: {
          show: false,
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function (event) {
            return `${event[0].seriesName}<br>${event[0].data.name}: ${event[0].data.totalValue}`
          }
        },
        legend: {
          show: false,
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          top: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'value',
          boundaryGap: [0, 0.01],
          axisLine: { show: false },
          axisTick: { show: false },
          axisLabel: { show: false },
          splitLine: { show: false },
        },
        yAxis: {
          type: 'category',
          data: this.yAxisData,
          axisLine: { show: false },
          axisTick: { show: false },
          axisLabel: {
            color: '#fff',
            fontSize: 20,
            margin: 20,
          }
        },
        series: this.seriesData
      })

      this.chart = myChart
    },
    methods: {
      upData() {
        let newList = [], max = 0
        let cScale = _.createColorL('#115ae4', '#92f696')
        this.dataconfig.forEach(item => {
          max = max > item.value ? max : item.value
          newList.unshift({ name: item.name, value: item.value, totalValue: item.value })
        })
        this.yAxisData = newList.map(item => item.name)
        let itemNum = parseInt(max / 4)
        let seriess = [], finish = false, index = 0
        do {
          let seriesItem = {
            name: '出差人员数',
            type: 'bar',
            stack: 'sum',
            barWidth: '30%',
            data: newList.map(item => {
              if (item.value > itemNum) {
                let itemStyle = {
                  normal: {
                    color: {
                      type: 'linear',
                      x: 0,
                      y: 0,
                      x2: 1,
                      y2: 0,
                      colorStops: [
                        { offset: 0, color: cScale.getColor(index * itemNum / item.totalValue) },
                        { offset: 1, color: cScale.getColor((index + 1) * itemNum / item.totalValue) }
                      ],
                      globalCoord: false,
                    }
                  },
                }
                item.value -= itemNum

                return { name: item.name, value: itemNum, itemStyle, totalValue: item.totalValue }
              } else if (item.value <= 0) {
                let itemStyle = {
                  normal: {
                    color: 'rgba(0,0,0,0)'
                  },
                }

                return { name: item.name, value: '-', itemStyle, totalValue: item.totalValue }
              } else {
                let itemStyle = {
                  normal: {
                    color: {
                      type: 'linear',
                      x: 0,
                      y: 0,
                      x2: 1,
                      y2: 0,
                      colorStops: [
                        { offset: 0, color: cScale.getColor(index * itemNum / item.totalValue) },
                        { offset: 1, color: cScale.getColor(1) }
                      ],
                      globalCoord: false,
                    }
                  },
                }
                let o = { name: item.name, value: item.value, itemStyle, totalValue: item.totalValue }
                item.value -= itemNum

                return o
              }
            }),
          }
          finish = newList.every(item => item.value <= 0)
          seriess.push(seriesItem)
          if (!finish) {
            seriess.push({
              name: 'notShow',
              type: 'bar',
              stack: 'sum',
              itemStyle: {
                normal: {
                  color: 'rgba(0,0,0,0)',
                },
              },
              barWidth: '30%',
              data: newList.map(item => {
                return { name: item.name, value: itemNum / 5 }
              }),
            })
          }
          index++
        } while (!finish);

        this.seriesData = seriess
      }
    },
    watch: {
      dataconfig: {
        deep: true,
        handler() {
          this.upData()

          this.chart.setOption({
            yAxis: { data: this.yAxisData },
            series: this.seriesData,
          })
        }
      }
    }
  })

  var vm = new Vue({
    el: '#main',
    data: {
      title: 'GDP TOP5',
      count: 100,
      data: [
        { name: '上海', value: 32 },
        { name: '广州', value: 22 },
        { name: '北京', value: 18 },
        { name: '杭州', value: 17 },
        { name: '深圳', value: 13 }
      ]
    },
    methods: {
      changeWH: function () {
        this.data = getD();
        this.style = {
          width: 400,
          height: 300
        };
      }
    }
  });

</script>

</html>